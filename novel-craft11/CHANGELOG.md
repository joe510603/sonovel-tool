# Changelog

本文档记录 NovelCraft 插件的所有版本变更。

格式基于 [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/)，
版本号遵循 [语义化版本](https://semver.org/lang/zh-CN/)。

## [1.5.0] - 2025-12-23

### 新增

#### 交互式拆书系统 (Requirements: 1.x - 9.x)
全新的作者主导深度拆书功能，通过手动标记和 AI 模板分析，帮助网络小说创作者学习和积累写作技巧。

##### 插入式标记系统
- 浮动工具栏支持在文本中插入开始/结束标记
- 支持跨章节内容标记，精确圈定长篇故事情节
- 支持多个并行标记同时进行
- 嵌套和重叠标记的视觉区分（不同颜色/样式）
- 侧边栏显示所有未完成标记的列表和状态

##### 标记类型分类
- 故事情节标记（主线/支线/独立故事/自定义）
- 设定信息标记（境界/功法/世界观/道具/势力）
- 场景标记（支持属性标签：冲突/铺垫/高潮/转折）
- 人物出场标记（自动识别或手动输入人物名称）

##### AI 模板分析系统
- 内置七步法分析模板（网文经典爽文套路）
- 支持自定义分析模板的创建和编辑
- 模板导入/导出功能
- 按模板结构生成可编辑的分析报告
- 情绪曲线和角色作用可视化

##### 跨书籍素材库
- 设定信息跨书籍汇总和对比
- 预设设定分类（境界设定/功法体系/世界观/道具设定/势力关系）
- 支持自定义设定分类
- 设定信息冲突检测和提示
- 素材库导出（思维导图/CSV/JSON 格式）

##### 人物追踪系统
- 人物出场自动识别和手动标记
- 人物故事线分析和汇总
- 人物与主线故事交集点分析
- 人物关系网络可视化

##### 分析结果展示
- 结构化分析报告面板
- 分析结果编辑和版本管理
- 情绪曲线图表展示
- 角色作用分析展示

##### 数据管理
- 每本书独立的标记数据库
- 实时保存所有标记和分析数据
- 重新打开书籍时恢复历史标记
- 支持单个或批量删除标记
- 多格式数据导出（JSON/CSV/Markdown）

##### 与现有功能集成
- AI 自动分析数据同步到手动拆书
- 手动标记关联 AI 分析中的人物信息
- 同时显示 AI 分析结果和手动标记内容
- 导出报告整合所有数据
- 数据冲突合并处理机制

##### 设置和配置
- 浮动工具栏开关选项
- 工具栏禁用时保留已有标记显示
- 设置变更立即生效无需重启

### 新增服务
- `InteractiveMarkingService` - 交互式标记核心服务
- `InteractiveMarkRepository` - 标记数据存储层
- `TemplateService` - AI 分析模板管理服务
- `StoryAnalyzer` - 故事情节分析器
- `CharacterTracker` - 人物追踪服务
- `CrossBookLibraryService` - 跨书籍素材库服务
- `SceneAttributeService` - 场景属性标签服务
- `DataIntegrationService` - 数据集成服务
- `ExportService` - 数据导出服务
- `ErrorHandlingService` - 统一错误处理服务
- `UserGuidanceService` - 用户引导服务
- `PerformanceOptimizationService` - 性能优化服务

### 新增 UI 组件
- `InteractiveFloatingToolbar` - 交互式浮动工具栏
- `MarkingSidebar` - 标记管理侧边栏
- `MarkTypeSelectionModal` - 标记类型选择弹窗
- `MarkVisualizer` - 标记可视化组件
- `InteractiveAnalysisPanel` - 交互式分析面板
- `DataIntegrationPanel` - 数据集成面板
- `ExportModal` - 数据导出弹窗

### 新增类型
- `InteractiveMark` - 交互式标记接口
- `MarkPair` - 标记配对接口
- `StoryPlot` - 故事情节接口
- `AnalysisTemplate` - 分析模板接口
- `AnalysisResult` - 分析结果接口
- `SettingCategory` - 设定分类接口
- `SettingEntry` - 设定条目接口
- `Character` - 人物接口
- `CharacterAppearance` - 人物出场接口

### 测试覆盖
- 230 个测试用例全部通过
- 15 个测试套件覆盖核心功能
- 包含单元测试和集成测试

---

## [1.4.1] - 2025-12-22

### 修复
- 修复 EPUB 转换后书籍无法添加到书库的问题
  - 根本原因：Obsidian 的文件索引缓存更新不及时，导致 `getAbstractFileByPath` 返回 null
  - 解决方案：`LibraryService` 改用 `adapter` API 直接读写文件，绕过文件索引缓存
- 修复阅读进度无法追踪的问题
  - 书籍数据现在正确保存到 `.library-data.json`
  - 打开章节时能正确更新阅读进度
- 修复插件启动时扫描现有书籍失败的 "File already exists" 错误
  - `ensureFolder()` 方法现在能正确处理文件夹已存在的情况
- 修复扫描现有书籍时章节数统计错误
  - 现在正确排除 `00-` 前缀的管理文件
- 修复分析笔记中的章节链接无法跳转到小说章节的问题
  - 情节分析中的"第X章"链接现在能正确链接到转换后的小说章节文件
  - `AnalysisService` 新增 `setConvertedBooksPath()` 方法配置章节链接路径
  - 链接格式：`[[NovelCraft/books/书名/01-章节标题|第1章]]`
- 修复分析过程中进度条不显示进度的问题
  - 各分析阶段内部的进度更新不再覆盖外层循环的进度百分比
  - 进度条现在能正确显示分析进度

### 变更
- `LibraryService.ts` 重构文件读写逻辑，使用 `adapter` API
- `AnalysisService.ts` 新增转换后书籍路径配置支持
- `AnalysisService.ts` 修改进度更新逻辑，支持 `-1` 表示不更新进度条
- `AnalysisView.ts` 和 `AnalysisPanel.ts` 在创建分析服务时配置章节链接路径
- 移除调试日志，保持控制台输出整洁

---

## [1.4.0] - 2025-12-22

### 新增

#### EPUB 转 Markdown 功能 (Requirements: 1.x - 8.x)
- 支持将 EPUB 小说转换为 Markdown 格式，在 Obsidian 中直接阅读
- 每个章节生成独立的 Markdown 文件，便于导航和链接
- 章节文件包含 YAML frontmatter（书名、章节号、标题、字数）
- 章节底部自动生成上一章/下一章导航链接
- 自动清理文件名中的特殊字符

#### 书籍管理文档
- 每本书生成管理文档 `00-{书名}-管理.md`
- 包含书籍基本信息（书名、作者、总章节数、总字数、转换时间）
- 包含阅读进度区域（当前章节、阅读状态、上次阅读时间）
- 包含"继续阅读"快捷链接
- 包含完整章节目录，已读章节标记 ✅，当前章节标记 📖
- 自动关联分析笔记链接

#### 书库总览文档
- 自动生成 `00-书库总览.md` 管理所有已转换的小说
- 包含统计信息（总书籍数、已读完、阅读中、未开始、总字数）
- 包含"正在阅读"区域，显示阅读中的书籍及进度
- 包含"最近添加"区域，显示最近转换的书籍
- 按阅读状态分组显示所有书籍
- 新书籍转换完成后自动更新

#### 阅读进度追踪
- 打开章节文件时自动更新阅读进度
- 同步更新书籍管理文档中的当前章节和上次阅读时间
- 支持标记书籍为"已读完"状态

#### 批量转换
- 支持批量转换多个 EPUB 文件
- 显示整体进度和当前处理的文件名
- 单个文件转换失败不影响其他文件
- 转换完成后显示结果摘要（成功数、失败数、跳过数）

#### 分析结果关联
- 分析笔记中的章节引用使用 Obsidian 链接格式
- 点击链接可直接跳转到对应章节文件

#### 转换设置
- 设置面板新增"EPUB 转换"设置区域
- 可配置输出路径（默认: NovelCraft/books）
- 可选择合并为单文件
- 可选择保留原始 HTML 标签

### 新增服务
- `EpubConverterService` - EPUB 到 Markdown 转换服务
- `LibraryService` - 书库管理服务
- `ReadingProgressService` - 阅读进度追踪服务

### 新增类型
- `ConversionOptions` - 转换选项接口
- `ConversionResult` - 转换结果接口
- `BatchConversionResult` - 批量转换结果接口
- `ReadingProgress` - 阅读进度接口
- `BookEntry` - 书籍条目接口
- `LibraryStats` - 书库统计接口
- `EpubConversionSettings` - EPUB 转换设置接口

---

## [1.3.3] - 2025-12-22

### 修复
- 修复下载完成时提示的书名与实际下载书籍不一致的问题
  - 在下载开始时保存书名到局部常量，避免异步操作中引用错误
- 修复可借鉴清单显示 `[object Object]` 的问题
  - 新增 `normalizeTakeaways()` 方法清洗 LLM 返回的数据
  - 支持处理对象数组、混合数组等多种格式
  - 自动提取对象中的 title、content、description 等字段

### 新增
- 下载按钮实时显示下载进度
  - 下载过程中按钮文本显示 "下载中 XX%"
  - 下载完成后显示 "已下载 ✓"
  - 下载失败后显示 "下载失败"

### 变更
- `SearchModal.ts` 重构 `downloadBook()` 方法，优化下载流程
- `AnalysisService.ts` 新增 `normalizeTakeaways()` 数据清洗方法
- `styles.css` 新增 `.nc-downloading` 下载中按钮样式

## [1.3.2] - 2024-12-22

### 修复
- 修复 Windows 环境下搜索功能 CORS 跨域错误
  - 使用 Obsidian 的 `requestUrl` API 替代原生 `fetch`
  - 绑过浏览器 CORS 限制，支持访问本地 SoNovel 服务
- 修复切换分析模式时 UI 元素未正确清除的问题
  - 切换到"追加分析"时正确移除"继续分析"的范围提示
  - 切换模式时正确移除"重新分析"的警告提示

### 变更
- `SoNovelService.ts` 重构所有 HTTP 请求使用 `requestUrl` API
- `AnalysisView.ts` 新增 `clearIncrementalModeUI()` 方法清理模式切换时的 UI 元素

## [1.3.1] - 2024-12-21

### 新增

#### 智能增量分析
- 分析前自动检测已分析的章节内容
- 智能判断重叠章节，弹出对话框询问用户处理方式：
  - **只分析新章节**：跳过已分析的章节，只分析未分析的部分
  - **重新分析全部**：覆盖现有分析结果
  - **取消**：取消本次分析
- 追加模式下自动在现有笔记末尾追加新内容，不覆盖原有分析
- 新增 `getSmartAnalysisSuggestion()` 方法智能分析章节重叠情况
- 新增 `getUnanalyzedRanges()` 方法获取未分析的章节范围
- 新增 `getOverlappingRanges()` 方法获取重叠的章节范围

### 修复
- 修复从现有笔记推断章节数时正则表达式匹配失败的问题
- 增强 `inferAnalyzedRangeFromNotes()` 方法，支持更多章节数格式：
  - `**章节数**: 30 章`
  - `章节数: 30`
  - `分析章节: 1-30`
  - `第1-30章`
  - `共30章`
- 添加详细的调试日志，便于排查章节检测问题

### 变更
- `AnalysisView.ts` 重构 `startAnalysis()` 方法，添加智能检测逻辑
- `MetadataService.ts` 新增智能分析建议相关方法
- `styles.css` 新增 `.nc-dialog-*` 和 `.nc-smart-analysis-dialog` 样式

## [1.3.0] - 2024-12-21

### 新增

#### 自动分批分析 (Requirements: 1.3.1.x, 1.3.2.x)
- 当用户选择超过 50 章进行分析时，自动显示分批分析建议
- 根据章节平均字数智能计算推荐批次大小：
  - 短章节 (< 3000 字/章)：每批 50 章
  - 中等章节 (3000-6000 字/章)：每批 30 章
  - 长章节 (6000-10000 字/章)：每批 20 章
  - 超长章节 (> 10000 字/章)：每批 10 章
- 新增 `analyzeBatched()` 方法支持自动分批分析
- 每批完成后即时保存结果，失败时保留已完成批次
- 批次失败时提供重试/跳过/中止选项
- 所有批次完成后自动合并结果

#### 混合模式分析 (Requirements: 1.3.3.x)
- 支持不同章节范围使用不同分析模式
- 元数据记录每个范围的独立分析模式
- 合并时保留模式特定数据
- 深度模式章节详情选择性包含

#### 分析设置配置 (Requirements: 1.3.4.x)
- 设置界面新增"分析设置"区域
- 可配置默认批次大小（默认 30 章）
- 可配置自动分批阈值（默认 50 章）
- 可选择合并模式：追加模式或智能合并模式
- 新增 `IncrementalAnalysisSettings` 类型定义

#### Windows 支持
- 新增 `run-windows.bat` 启动脚本
- 自动检测 Java 环境
- 提示 Java 下载地址（如未安装）

### 变更
- `AnalysisView.ts` 新增分批建议相关逻辑和 UI 元素
- `AnalysisService.ts` 新增 `analyzeBatched()` 方法
- `SettingTab.ts` 新增分析设置配置区域
- `types/index.ts` 新增增量分析相关类型定义
- `styles.css` 新增 `.nc-batch-suggestion-*` 系列样式类

### 修复
- 修复 Windows 批处理脚本中文编码问题（使用纯英文避免兼容性问题）

---

## [1.2.0] - 2024-12-20

### 新增

#### 智能合并服务 (Requirements: 1.2.1.x)
- 新增 `MergeService` 服务，支持分析结果的智能合并
- 人物分析按名称合并，更新成长弧线
- 技法分析去重并合并示例
- 情绪曲线按章节排序
- 章节结构去重并保持顺序

#### 断点续传 (Requirements: 1.2.2.x)
- 新增 `CheckpointService` 服务，支持分析中断后恢复
- 分析过程中自动保存断点
- 支持从断点继续分析，跳过已完成阶段
- 新增断点状态 UI 显示

#### 统一视图 (Requirements: 1.2.3.x)
- 笔记生成支持范围标注
- 合并结果显示来源范围信息

---

## [1.1.0] - 2024-12-19

### 新增

#### 基础增量分析 (Requirements: 1.1.x)
- 新增 `MetadataService` 服务，管理分析元数据
- 支持查看已分析章节范围和日期
- 支持三种分析模式：继续分析、追加分析、重新分析
- 分析完成后自动保存元数据
- 新增增量分析模式选择 UI

#### 笔记追加功能 (Requirements: 1.1.4.x)
- `NoteGenerator` 支持追加模式
- 追加内容带章节范围标注头部
- 技法笔记支持同名合并

---

## [1.0.0] - 2024-12-15

### 新增

#### 核心功能
- EPUB/TXT/PDF/DOCX 文档解析
- LLM 驱动的小说分析（快速/标准/深度三种模式）
- 12 种小说类型支持 + 自定义类型
- 分析结果自动生成 Markdown 笔记
- Token 使用预估和追踪

#### 分析内容
- 故事梗概提取
- 人物分析（主角/配角/反派）
- 写作技法识别
- 情绪曲线分析（标准/深度模式）
- 章节结构分析（标准/深度模式）
- 伏笔分析（标准/深度模式）
- 逐章拆解（深度模式）
- 写作复盘（深度模式）

#### UI 功能
- 侧边栏分析视图
- 实时分析进度显示
- 分析结果预览
- 暂停/终止分析控制
- 设置面板（LLM 配置、自定义提示词等）

---

## 版本规划

### 未来计划
- 多书籍对比分析
- 写作风格学习建议
- 导出分析报告（PDF/Word）
- 云端同步分析结果
- 属性测试覆盖（可选）
