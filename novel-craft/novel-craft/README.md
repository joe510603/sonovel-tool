# NovelCraft - 网络小说拆书分析插件

一款 Obsidian 插件，帮助网文作者和爱好者深度分析小说的写作技法、人物塑造、情节结构，并生成结构化的学习笔记。

## ✨ 功能特点

### 📚 多格式文档支持
- **EPUB** - 电子书格式，自动解析章节结构
- **TXT** - 纯文本格式，智能章节分割，自动编码检测（UTF-8/GBK）
- **DOCX** - Word 文档格式
- **PDF** - PDF 文档格式
- 集成 SoNovel 服务，可在线搜索和下载小说
- 自动识别章节结构和元数据

### 🔍 智能分析
- **快速模式**：故事梗概、核心人物、主要写作技法
- **标准模式**：快速模式 + 情绪曲线、章节结构、伏笔分析
- **深度模式**：标准模式 + 逐章拆解、写作复盘

### 📝 笔记生成
- 自动生成结构化分析笔记
- 增量生成：每完成一个分析阶段立即生成对应笔记
- 笔记类型：概览、人物图谱、情节分析、写作技法

### 🔄 增量分析
- **继续分析**：从上次分析结束的章节自动继续
- **追加分析**：自定义范围追加分析新章节
- **重新分析**：覆盖已有分析结果重新开始
- **断点续传**：分析中断后可从断点恢复
- **智能合并**：新旧分析结果自动合并
- **自动分批**：长篇小说自动建议分批分析

### 💬 交互式追问
- 侧边栏视图，分析时不阻塞文档操作
- 流式响应，实时显示 AI 回答进度和字数
- 支持选择特定章节进行针对性讨论
- **支持选择已有分析结果**，无需重新分析即可对话
- 对话历史可保存为笔记

### 📊 Token 管理
- 分析前预估 Token 消耗
- 实时显示分析过程中的 Token 使用
- 历史消耗统计和清除功能

### ⚙️ 灵活配置
- 支持多种 LLM 服务（OpenAI、Claude、DeepSeek 等）
- 12+ 种小说类型专属提示词
- 可自定义分析范围（全书或指定章节）
- 分析过程支持暂停和终止
- 自定义提示词编辑器

## 📦 安装

### 手动安装
1. 下载最新 release
2. 解压到 Obsidian 插件目录：`<vault>/.obsidian/plugins/novel-craft/`
3. 重启 Obsidian
4. 在设置中启用 NovelCraft 插件

### 从源码构建
```bash
cd novel-craft
npm install
npm run build
```

## 🚀 快速开始

### 1. 配置 LLM 服务
打开设置 → NovelCraft → LLM 配置，添加你的 AI 服务：

| 服务商 | API 地址 |
|--------|----------|
| OpenAI | `https://api.openai.com/v1` |
| Claude | `https://api.anthropic.com` |
| DeepSeek | `https://api.deepseek.com` |

### 2. 导入小说
- 方式一：直接将文档文件拖入 Vault（支持 epub/txt/docx/pdf）
- 方式二：使用主面板搜索下载（需配置 SoNovel 服务）

### 3. 开始分析
1. 点击左侧 📚 图标打开主面板
2. 在 "Vault" 标签页找到你的文档文件
3. 点击 "分析" 按钮
4. 选择分析模式、小说类型和章节范围
5. 查看 Token 预估，点击 "开始分析"

### 4. 追问对话
分析完成后，点击主面板底部的 "💬 打开对话" 按钮：
- 在右侧边栏中输入问题
- 实时查看 AI 回答进度
- 可选择特定章节获得更精准的回答

## 📖 使用指南

### 分析模式选择

| 模式 | 适用场景 | Token 消耗 |
|------|----------|------------|
| 快速 | 快速了解一本书 | 低 |
| 标准 | 学习写作技法 | 中 |
| 深度 | 深入研究经典作品 | 高 |

### 小说类型

支持 12+ 种小说类型，每种类型有专属的分析提示词：
- 都市、玄幻、仙侠、武侠、科幻
- 历史、悬疑、言情、游戏、末日
- 轻小说、同人、自定义

### 章节范围设置
- **全书**：分析整本书（适合短篇或经典作品）
- **自定义**：指定章节范围（推荐用于长篇网文）
- 快捷按钮：前10章、前30章、前50章、前100章

### 控制分析过程
- **暂停**：暂停当前分析，可随时继续
- **终止**：停止分析，已生成的笔记会保留

### 增量分析
对于长篇小说，推荐使用增量分析功能：

1. **首次分析**：选择前 30-50 章进行分析
2. **继续分析**：点击"继续分析"自动从上次结束位置继续
3. **追加分析**：指定新的章节范围追加分析
4. **断点恢复**：如果分析中断，下次打开会提示从断点继续

增量分析的优势：
- 避免一次性分析过多章节导致超时
- 每批分析结果即时保存，不会丢失
- 智能合并多次分析结果，生成统一视图

## ⚙️ 配置说明

### LLM 配置
| 选项 | 说明 |
|------|------|
| 服务名称 | 自定义名称，便于识别 |
| API 地址 | LLM 服务的 API 端点 |
| API Key | 你的 API 密钥 |
| 模型 | 使用的模型名称 |

### 路径配置
| 选项 | 默认值 | 说明 |
|------|--------|------|
| 下载路径 | `downloads` | epub 文件保存位置 |
| 笔记路径 | `NovelCraft/notes` | 分析笔记保存位置 |

### 增量分析配置
| 选项 | 默认值 | 说明 |
|------|--------|------|
| 默认批次大小 | 30 | 分批分析时每批章节数 |
| 自动分批阈值 | 50 | 超过此章节数时建议分批 |
| 合并模式 | merge | append(追加) 或 merge(智能合并) |

### 提示词自定义
在设置中可以自定义各分析阶段和小说类型的提示词，以获得更符合个人需求的分析结果。

## 🛠️ 命令列表

| 命令 | 说明 |
|------|------|
| `NovelCraft: 打开主面板` | 打开侧边栏主面板 |
| `NovelCraft: 搜索小说` | 打开搜索弹窗 |
| `NovelCraft: 分析当前书籍` | 分析当前打开的文档文件 |
| `NovelCraft: 打开对话` | 打开追问对话（可选择已有分析） |

## 📁 生成的笔记结构

```
NovelCraft/notes/
└── 书名/
    ├── 00-概览.md          # 书籍信息、故事梗概
    ├── 01-人物图谱.md      # 人物分析、关系网络
    ├── 02-情节分析.md      # 章节结构、情绪曲线、伏笔
    ├── 03-写作技法.md      # 技法总结、可借鉴清单
    └── 章节笔记/           # 深度模式下的逐章分析
        ├── 001-第一章.md
        └── ...
```

## 🔧 开发

```bash
npm install     # 安装依赖
npm run dev     # 开发构建
npm run build   # 生产构建
npm test        # 运行测试
```

## 📄 许可证

MIT License

## 🙏 致谢

- [Obsidian](https://obsidian.md/) - 强大的知识管理工具
- [SoNovel](https://github.com/freeok/so-novel) - 小说搜索下载服务
- [JSZip](https://stuk.github.io/jszip/) - EPUB 解析支持
- [mammoth](https://github.com/mwilliamson/mammoth.js) - DOCX 解析支持
- [pdfjs-dist](https://github.com/nicolo-ribaudo/pdfjs-dist) - PDF 解析支持
