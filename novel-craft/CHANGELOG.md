# Changelog

本文档记录 NovelCraft 插件的所有版本变更。

格式基于 [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/)，
版本号遵循 [语义化版本](https://semver.org/lang/zh-CN/)。

## [1.3.3] - 2024-12-22

### 修复
- 修复下载完成时提示的书名与实际下载书籍不一致的问题
  - 在下载开始时保存书名到局部常量，避免异步操作中引用错误
- 修复可借鉴清单显示 `[object Object]` 的问题
  - 新增 `normalizeTakeaways()` 方法清洗 LLM 返回的数据
  - 支持处理对象数组、混合数组等多种格式
  - 自动提取对象中的 title、content、description 等字段

### 新增
- 下载按钮实时显示下载进度
  - 下载过程中按钮文本显示 "下载中 XX%"
  - 下载完成后显示 "已下载 ✓"
  - 下载失败后显示 "下载失败"

### 变更
- `SearchModal.ts` 重构 `downloadBook()` 方法，优化下载流程
- `AnalysisService.ts` 新增 `normalizeTakeaways()` 数据清洗方法
- `styles.css` 新增 `.nc-downloading` 下载中按钮样式

## [1.3.2] - 2024-12-22

### 修复
- 修复 Windows 环境下搜索功能 CORS 跨域错误
  - 使用 Obsidian 的 `requestUrl` API 替代原生 `fetch`
  - 绑过浏览器 CORS 限制，支持访问本地 SoNovel 服务
- 修复切换分析模式时 UI 元素未正确清除的问题
  - 切换到"追加分析"时正确移除"继续分析"的范围提示
  - 切换模式时正确移除"重新分析"的警告提示

### 变更
- `SoNovelService.ts` 重构所有 HTTP 请求使用 `requestUrl` API
- `AnalysisView.ts` 新增 `clearIncrementalModeUI()` 方法清理模式切换时的 UI 元素

## [1.3.1] - 2024-12-21

### 新增

#### 智能增量分析
- 分析前自动检测已分析的章节内容
- 智能判断重叠章节，弹出对话框询问用户处理方式：
  - **只分析新章节**：跳过已分析的章节，只分析未分析的部分
  - **重新分析全部**：覆盖现有分析结果
  - **取消**：取消本次分析
- 追加模式下自动在现有笔记末尾追加新内容，不覆盖原有分析
- 新增 `getSmartAnalysisSuggestion()` 方法智能分析章节重叠情况
- 新增 `getUnanalyzedRanges()` 方法获取未分析的章节范围
- 新增 `getOverlappingRanges()` 方法获取重叠的章节范围

### 修复
- 修复从现有笔记推断章节数时正则表达式匹配失败的问题
- 增强 `inferAnalyzedRangeFromNotes()` 方法，支持更多章节数格式：
  - `**章节数**: 30 章`
  - `章节数: 30`
  - `分析章节: 1-30`
  - `第1-30章`
  - `共30章`
- 添加详细的调试日志，便于排查章节检测问题

### 变更
- `AnalysisView.ts` 重构 `startAnalysis()` 方法，添加智能检测逻辑
- `MetadataService.ts` 新增智能分析建议相关方法
- `styles.css` 新增 `.nc-dialog-*` 和 `.nc-smart-analysis-dialog` 样式

## [1.3.0] - 2024-12-21

### 新增

#### 自动分批分析 (Requirements: 1.3.1.x, 1.3.2.x)
- 当用户选择超过 50 章进行分析时，自动显示分批分析建议
- 根据章节平均字数智能计算推荐批次大小：
  - 短章节 (< 3000 字/章)：每批 50 章
  - 中等章节 (3000-6000 字/章)：每批 30 章
  - 长章节 (6000-10000 字/章)：每批 20 章
  - 超长章节 (> 10000 字/章)：每批 10 章
- 新增 `analyzeBatched()` 方法支持自动分批分析
- 每批完成后即时保存结果，失败时保留已完成批次
- 批次失败时提供重试/跳过/中止选项
- 所有批次完成后自动合并结果

#### 混合模式分析 (Requirements: 1.3.3.x)
- 支持不同章节范围使用不同分析模式
- 元数据记录每个范围的独立分析模式
- 合并时保留模式特定数据
- 深度模式章节详情选择性包含

#### 分析设置配置 (Requirements: 1.3.4.x)
- 设置界面新增"分析设置"区域
- 可配置默认批次大小（默认 30 章）
- 可配置自动分批阈值（默认 50 章）
- 可选择合并模式：追加模式或智能合并模式
- 新增 `IncrementalAnalysisSettings` 类型定义

#### Windows 支持
- 新增 `run-windows.bat` 启动脚本
- 自动检测 Java 环境
- 提示 Java 下载地址（如未安装）

### 变更
- `AnalysisView.ts` 新增分批建议相关逻辑和 UI 元素
- `AnalysisService.ts` 新增 `analyzeBatched()` 方法
- `SettingTab.ts` 新增分析设置配置区域
- `types/index.ts` 新增增量分析相关类型定义
- `styles.css` 新增 `.nc-batch-suggestion-*` 系列样式类

### 修复
- 修复 Windows 批处理脚本中文编码问题（使用纯英文避免兼容性问题）

---

## [1.2.0] - 2024-12-20

### 新增

#### 智能合并服务 (Requirements: 1.2.1.x)
- 新增 `MergeService` 服务，支持分析结果的智能合并
- 人物分析按名称合并，更新成长弧线
- 技法分析去重并合并示例
- 情绪曲线按章节排序
- 章节结构去重并保持顺序

#### 断点续传 (Requirements: 1.2.2.x)
- 新增 `CheckpointService` 服务，支持分析中断后恢复
- 分析过程中自动保存断点
- 支持从断点继续分析，跳过已完成阶段
- 新增断点状态 UI 显示

#### 统一视图 (Requirements: 1.2.3.x)
- 笔记生成支持范围标注
- 合并结果显示来源范围信息

---

## [1.1.0] - 2024-12-19

### 新增

#### 基础增量分析 (Requirements: 1.1.x)
- 新增 `MetadataService` 服务，管理分析元数据
- 支持查看已分析章节范围和日期
- 支持三种分析模式：继续分析、追加分析、重新分析
- 分析完成后自动保存元数据
- 新增增量分析模式选择 UI

#### 笔记追加功能 (Requirements: 1.1.4.x)
- `NoteGenerator` 支持追加模式
- 追加内容带章节范围标注头部
- 技法笔记支持同名合并

---

## [1.0.0] - 2024-12-15

### 新增

#### 核心功能
- EPUB/TXT/PDF/DOCX 文档解析
- LLM 驱动的小说分析（快速/标准/深度三种模式）
- 12 种小说类型支持 + 自定义类型
- 分析结果自动生成 Markdown 笔记
- Token 使用预估和追踪

#### 分析内容
- 故事梗概提取
- 人物分析（主角/配角/反派）
- 写作技法识别
- 情绪曲线分析（标准/深度模式）
- 章节结构分析（标准/深度模式）
- 伏笔分析（标准/深度模式）
- 逐章拆解（深度模式）
- 写作复盘（深度模式）

#### UI 功能
- 侧边栏分析视图
- 实时分析进度显示
- 分析结果预览
- 暂停/终止分析控制
- 设置面板（LLM 配置、自定义提示词等）

---

## 版本规划

### 未来计划
- 多书籍对比分析
- 写作风格学习建议
- 导出分析报告（PDF/Word）
- 云端同步分析结果
- 属性测试覆盖（可选）
