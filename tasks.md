# 拆书插件时间线可视化功能实现计划

## 实现说明

本实现计划将功能设计转换为一系列代码生成任务，每个任务都基于前一个任务的成果，最终形成完整的时间线可视化功能。所有任务都专注于代码编写、修改和测试，确保增量开发和功能集成。

### 核心架构优化

#### 数据库存储层设计
- **选型**: 使用 IndexedDB（推荐 dexie.js ORM 库）作为本地数据库，适配 Obsidian 插件环境
- **核心表设计**:

| 表名 | 核心字段 | 作用 |
|------|----------|------|
| books | id, title, author, import_time, file_path | 存储书籍元数据 |
| ai_analysis | id, book_id, template_type, analysis_result, edit_status, create_time | 存储 AI 分析结果（七步故事法/自定义模板） |
| story_units | id, book_id, title, chapter_range, track_id, ai_analysis_id, time_position | 存储故事单元（关联 AI 分析结果 ID） |
| relations | id, source_unit_id, target_unit_id, relation_type, description | 存储故事单元关联关系 |
| characters | id, book_id, name, role, relationships, appearances | 存储人物信息和关系 |

#### 数据对齐保障
- AI 分析结果写入数据库时，关联 book_id
- 故事单元创建时，关联 book_id 和 ai_analysis_id  
- 时间线渲染时，从数据库读取 story_units + ai_analysis 数据，确保全流程数据对齐
- 所有功能通过 DBService 统一操作数据，确保数据唯一来源

## 任务列表

- [-] 1. 项目基建搭建（核心前置）
  - [x] 1.1 建立分层目录结构与类型定义
    - 创建 types/core/services/ui/utils 目录
    - 定义核心 TS 接口（含数据库映射类型）
    - 设置错误处理基类和插件特有错误类型
    - 配置开发环境/构建工具
    - _需求: 8.2, 8.3_

  - [x] 1.2 搭建数据库存储层（AI分析数据对齐核心）
    - 选择数据库（推荐 Obsidian 插件常用的 **IndexedDB**，轻量且本地化）
    - 设计数据表（书籍表/AI分析结果表/故事单元表）
    - 实现数据库 CRUD 服务（DBService），关联 TypeScript 模型
    - 编写数据库连接/数据映射单元测试
    - _核心目标: 为AI分析结果提供持久化存储，确保后续功能数据对齐_

  - [x] 1.3 检查点 - 基建层验证
    - 目录结构/类型定义/数据库服务可正常运行
    - 数据库 CRUD 测试通过，如有问题及时调整

- [-] 2. 实现书籍导入功能（优先核心）
  - [x] 2.1 创建 EPUB 解析和转换服务
    - 实现 EpubParser 文件结构解析
    - 创建 MarkdownConverter 内容转换逻辑
    - 保持章节结构/标题层级，生成 MD 文档
    - _需求: 7.1, 7.2_

  - [x] 2.2 实现文件组织与元数据管理
    - 创建书籍文件夹，生成元数据（book.json）
    - 导入进度显示+中文错误提示（如解析失败）
    - 元数据/MD文件写入数据库（关联书籍ID）
    - _需求: 7.3, 7.4_

  - [x] 2.3 书籍导入功能测试（属性+单元）
    - [x] 2.3.1 编写 EPUB 转换结构保持属性测试（属性11）
    - [x] 2.3.2 编写文件转换输出完整性属性测试（属性12）
    - [x] 2.3.3 编写单元测试（解析/转换/错误处理/数据库写入）

  - [x] 2.4 检查点 - 书籍导入功能验证
    - 确保 EPUB 导入→MD 转换→数据库存储全流程正常
    - 所有测试通过，数据可在数据库中查询

- [ ] 4. 实现故事单元核心功能
  - [ ] 3. 实现 AI 分析功能（带数据库存储，核心对齐）
  - [ ] 3.1 实现 AI 分析服务与数据库集成
    - 创建 AIAnalysisEngine（复用现有 LLM 配置）
    - 设计 AI 分析结果数据库表（关联书籍ID，存储七步故事法/自定义模板结果）
    - 实现 AI 分析结果→数据库的写入/查询/更新逻辑
    - _需求: 1.5, 2.1, 2.2_

  - [ ] 3.2 实现 AI 分析模板系统与 UI
    - 支持七步故事法（默认）+自定义模板
    - 实现 AI 分析进度显示+流式响应
    - 新增 AI 分析结果编辑界面（支持手动修改）
    - _需求: 2.2, 2.3, 2.4, 2.5_

  - [ ] 3.3 AI 分析功能测试（属性+单元）
    - [ ] 3.3.1 编写 AI 分析结果编辑状态一致性属性测试（属性2）
    - [ ] 3.3.2 编写单元测试（模板拼接/LLM调用/数据库存储/手动编辑）
    - [ ] 3.3.3 验证：修改 AI 分析结果后，数据库同步更新

  - [ ] 3.4 检查点 - AI 分析功能验证
    - AI 分析结果可持久化到数据库，手动编辑后同步正常
    - 支持按书籍ID查询AI分析结果，为后续功能提供数据

- [ ] 4. 实现故事单元核心功能（复用 AI 分析数据）
  - [ ] 4.1 故事单元数据模型与服务（关联数据库）
    - 实现 StoryUnit/Track/TimePosition 模型（关联书籍ID+AI分析结果ID）
    - 创建 IStoryUnitService 接口（复用数据库CRUD）
    - 实现故事单元 CRUD（关联 AI 分析结果）
    - _需求: 1.1, 1.2, 1.3, 1.4_

  - [ ] 4.2 实现跨章节标记功能
    - 创建章节选择 UI，支持跨章节标记
    - 自动关联数据库中的书籍章节/AI分析结果
    - 实现文本提取+人物自动关联
    - _需求: 1.1, 1.2, 1.3, 1.4_

  - [ ] 4.3 故事单元功能测试
    - [ ] 4.3.1 编写故事单元配置完整性属性测试（属性1）
    - [ ] 4.3.2 编写单元测试（标记逻辑/数据库关联/文本提取）

  - [ ] 4.4 检查点 - 故事单元功能验证
    - 故事单元可关联数据库中的AI分析结果，数据对齐无问题

- [ ] 5. 实现时间线可视化核心功能
  - [ ] 5.1 时间线渲染引擎（关联数据库）
    - 实现 TimelineRenderer+虚拟列表渲染
    - 轨道管理+时间轴刻度（复用数据库中的故事单元数据）
    - _需求: 3.1, 3.2, 9.1_

  - [ ] 5.2 故事单元拖拽交互
    - 拖拽事件处理+位置更新（同步至数据库）
    - 章节刻度提示+边界检查
    - _需求: 3.4, 3.5_

  - [ ] 5.3 时间线 UI 与工具栏
    - 主界面布局+缩放/导出功能
    - 书名编辑+轨道管理
    - _需求: 3.1, 3.2, 3.3_

  - [ ] 5.4 时间线功能测试
    - [ ] 5.4.1 时间线轨道布局正确性属性测试（属性3）
    - [ ] 5.4.2 故事单元拖拽位置更新属性测试（属性4）

  - [ ] 5.5 检查点 - 时间线功能验证
    - 时间线可正常渲染数据库中的故事单元，拖拽同步正常

- [ ] 6. 实现关联关系管理功能
  - [ ] 6.1 关联关系数据模型与服务（关联数据库）
    - 实现 Relation/RelationType 模型，关联数据库中的故事单元ID
    - 关联线坐标计算+SVG绘制
    - _需求: 4.1, 4.3, 9.2_

  - [ ] 6.2 关联关系交互功能
    - 工具栏选择/Alt键拖拽创建关联
    - 悬停信息+编辑/删除功能
    - _需求: 4.2, 4.4, 4.5_

  - [ ] 6.3 关联关系测试
    - [ ] 6.3.1 关联关系可视化一致性属性测试（属性5）
    - [ ] 6.3.2 单元测试（关联创建/数据库同步/渲染）

  - [ ] 6.4 检查点 - 关联关系功能验证

- [ ] 7. 实现人物关系图谱功能
  - [ ] 7.1 人物图谱渲染引擎（关联数据库）
    - 集成 vis-network，复用数据库中的人物/故事单元数据
    - 节点大小权重计算（关联AI分析的"戏份权重"）
    - _需求: 5.1, 5.2_

  - [ ] 7.2 人物关系可视化与编辑
    - 实线/虚线/渐变线表示关系（同步至数据库）
    - 关系新增/修改/删除 UI
    - _需求: 5.3, 5.4_

  - [ ] 7.3 人物关系测试
    - [ ] 7.3.1 人物图谱节点权重属性测试（属性6）
    - [ ] 7.3.2 人物关系视觉表示规则属性测试（属性7）
    - [ ] 7.3.3 人物关系编辑完整性属性测试（属性8）

  - [ ] 7.4 检查点 - 人物图谱功能验证

- [ ] 8. 数据同步与性能优化
  - [ ] 8.1 数据双向同步服务（数据库+MD文件）
    - 实现 DataSyncService，确保数据库↔MD文件双向同步
    - 冲突处理+历史版本管理
    - _需求: 6.1-6.5_

  - [ ] 8.2 性能优化（虚拟列表/缓存/主题适配）
    - 虚拟列表渲染优化（单轨道≤50单元）
    - LRU 缓存（AI分析结果/时间线配置）
    - Obsidian 主题适配+导出功能（SVG/PNG）
    - _需求: 9.1, 9.4, 9.5_

  - [ ] 8.3 数据同步测试
    - [ ] 8.3.1 数据双向同步一致性属性测试（属性9）
    - [ ] 8.3.2 配置持久化完整性属性测试（属性10）
    - [ ] 8.3.3 性能优化单元测试

  - [ ] 8.4 检查点 - 数据同步+性能验证

- [ ] 9. 最终全流程测试与验收
  - [ ] 9.1 端到端测试（书籍导入→AI分析→故事单元→时间线→人物图谱）
  - [ ] 9.2 所有属性测试/单元测试通过
  - [ ] 9.3 性能测试（大数据量下无卡顿）
  - [ ] 9.4 最终验收 - 所有功能正常运行